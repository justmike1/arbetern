<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <title>ovad — Agent Manager</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #000000;
      --surface: #070707;
      --card: #0c0c0c;
      --card-hover: #111111;
      --border: #1a1a1a;
      --border-accent: #242424;
      --text: #b0b8c1;
      --text-muted: #6b7685;
      --accent: #4a8ad4;
      --accent-glow: rgba(74, 138, 212, 0.06);
      --green: #2e9444;
      --radius: 10px;
      --radius-lg: 12px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Header ─────────────────────────────────── */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 32px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #fff;
    }

    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 8px;
    }

    .logo-icon.has-logo {
      background: transparent;
    }

    .header-badge {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--card);
      padding: 4px 10px;
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    /* ── Main Grid ──────────────────────────────── */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
    }

    .agents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    /* ── Agent Card ─────────────────────────────── */
    .agent-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .agent-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--border-accent);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .agent-card:hover {
      background: var(--card-hover);
      border-color: var(--border-accent);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .agent-card:hover::before {
      opacity: 1;
    }

    .agent-card-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 14px;
    }

    .agent-avatar {
      width: 44px;
      height: 44px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    .agent-info { flex: 1; min-width: 0; }

    .agent-name {
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .agent-profession {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .agent-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--green);
      margin-top: 12px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      background: var(--green);
      border-radius: 50%;
    }

    .agent-prompts-count {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* ── Modal / Slide-over ─────────────────────── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: min(560px, 100vw);
      background: var(--surface);
      border-left: 1px solid var(--border);
      z-index: 201;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      flex-direction: column;
    }

    .modal-overlay.active .modal-panel {
      transform: translateX(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .modal-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-agent-avatar {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
    }

    .modal-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .modal-close {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.15s ease;
    }

    .modal-close:hover {
      color: var(--text);
      background: var(--card-hover);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .prompt-section {
      margin-bottom: 24px;
    }

    .prompt-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .prompt-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      font-size: 13px;
      line-height: 1.7;
      color: var(--text-muted);
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'SF Mono', 'Fira Code', monospace;
      user-select: text;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .readonly-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      background: var(--card);
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 20px;
    }

    .readonly-badge svg {
      width: 14px;
      height: 14px;
    }

    /* ── Empty State ────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state p {
      font-size: 14px;
      max-width: 320px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* ── Scrollbar ──────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* ── Integrations Grid ──────────────────────── */
    .integrations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 36px;
    }

    .integration-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      text-align: center;
      position: relative;
    }

    .integration-card:hover {
      background: var(--card-hover);
      border-color: var(--border-accent);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .integration-card.expanded {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
      background: var(--card-hover);
      transform: none;
    }

    .integration-detail-panel {
      background: var(--card);
      border: 1px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px;
      margin-top: 12px;
      margin-bottom: 36px;
      animation: panelSlideIn 0.2s ease;
    }

    @keyframes panelSlideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .integration-detail-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .integration-active-model {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text);
      margin-bottom: 14px;
      padding: 8px 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      width: fit-content;
    }

    .integration-active-model .model-label {
      font-weight: 600;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .integration-active-model .model-value {
      font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
      color: var(--text);
    }

    .integration-detail-header .integration-logo {
      width: 32px;
      height: 32px;
    }

    .integration-detail-close {
      margin-left: auto;
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
      border-radius: 6px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .integration-detail-close:hover {
      color: var(--text);
      background: var(--card-hover);
    }

    .integration-logo {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
    }

    .integration-logo svg {
      width: 100%;
      height: 100%;
    }

    .integration-name {
      font-size: 14px;
      font-weight: 600;
    }

    .integration-status {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
    }

    .integration-status.connected {
      color: var(--green);
      background: rgba(46, 148, 68, 0.06);
      border: 1px solid rgba(46, 148, 68, 0.12);
    }

    .integration-status.disconnected {
      color: #c44040;
      background: rgba(196, 64, 64, 0.06);
      border: 1px solid rgba(196, 64, 64, 0.12);
    }

    .integration-auth-mode {
      font-size: 11px;
      color: var(--text-muted);
    }

    .integration-header {
      display: flex;
      align-items: center;
      gap: 14px;
      width: 100%;
      cursor: pointer;
    }

    .integration-header-info {
      flex: 1;
    }

    .integration-collapse-btn {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      width: 28px;
      height: 28px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .integration-collapse-btn:hover {
      color: var(--text);
      background: var(--card-hover);
    }

    .permissions-table {
      width: 100%;
      margin-top: 14px;
      border-collapse: collapse;
    }

    .permissions-table th {
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
    }

    .permissions-table td {
      font-size: 13px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    .permissions-table tr:last-child td {
      border-bottom: none;
    }

    .permissions-table .scope-name {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 12px;
      color: var(--text);
      white-space: nowrap;
    }

    .permissions-table .scope-desc {
      color: var(--text-muted);
    }

    .perm-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .perm-badge.required {
      color: #a67c1a;
      background: rgba(166, 124, 26, 0.08);
    }

    .perm-badge.optional {
      color: var(--text-muted);
      background: var(--card);
    }

    .perm-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .perm-status.granted {
      color: #2e9444;
      background: rgba(46, 148, 68, 0.06);
    }

    .perm-status.denied {
      color: #c44040;
      background: rgba(196, 64, 64, 0.06);
    }

    .perm-status.unknown {
      color: var(--text-muted);
      background: var(--card);
    }

    .perm-status.warning {
      color: #a67c1a;
      background: rgba(166, 124, 26, 0.06);
    }

    .perm-badge.extra {
      color: #a67c1a;
      background: rgba(166, 124, 26, 0.06);
    }

    .perm-status-icon {
      font-size: 12px;
    }

    /* ── Responsive ─────────────────────────────── */
    @media (max-width: 640px) {
      header { padding: 16px; }
      main { padding: 20px 16px; }
      .agents-grid { grid-template-columns: 1fr; }
      .integrations-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">
      <div class="logo-icon" id="logo-icon">O</div>
      <span id="header-title">ovad</span>
    </div>
    <span class="header-badge" id="agent-count">0 agents</span>
  </header>

  <main>
    <div class="section-title">Integrations</div>
    <div class="integrations-grid" id="integrations-grid">
      <div class="empty-state" style="grid-column:1/-1;padding:30px;">
        <p>Loading integrations...</p>
      </div>
    </div>
    <div id="integration-detail"></div>

    <div class="section-title">Agents</div>
    <div class="agents-grid" id="agents-grid">
      <div class="empty-state">
        <div class="empty-state-icon">&#x1f916;</div>
        <p>Loading agents...</p>
      </div>
    </div>
  </main>

  <!-- Slide-over panel -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-panel" id="modal-panel">
      <div class="modal-header">
        <div class="modal-header-left">
          <div class="modal-agent-avatar" id="modal-avatar"></div>
          <div>
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-subtitle" id="modal-subtitle"></div>
          </div>
        </div>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer">
        <div class="readonly-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          Read-only — prompts cannot be edited from the UI
        </div>
      </div>
    </div>
  </div>

  <script>
    const AGENT_COLORS = [
      '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e',
      '#f97316', '#eab308', '#22c55e', '#14b8a6',
      '#06b6d4', '#3b82f6',
    ];

    function hashColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      return AGENT_COLORS[Math.abs(hash) % AGENT_COLORS.length];
    }

    function getAgentProfession(agent) {
      // Try to extract profession from the general or security prompt's first meaningful line.
      const general = (agent.prompts || {}).general || '';
      const match = general.match(/You are (?:a |an )?([^.\n]+)/i);
      if (match) return match[1].trim();
      return agent.id;
    }

    function renderAgents(agents) {
      const grid = document.getElementById('agents-grid');
      const countBadge = document.getElementById('agent-count');
      countBadge.textContent = `${agents.length} agent${agents.length !== 1 ? 's' : ''}`;

      if (agents.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1f916;</div>
            <p>No agents configured yet. Agents will appear here once created.</p>
          </div>`;
        return;
      }

      grid.innerHTML = agents.map(agent => {
        const color = hashColor(agent.name);
        const initial = agent.name.charAt(0).toUpperCase();
        const promptCount = Object.keys(agent.prompts || {}).length;
        return `
          <div class="agent-card" data-agent-id="${agent.id}" onclick="openAgent('${agent.id}')">
            <div class="agent-card-header">
              <div class="agent-avatar" style="background:${color}">${initial}</div>
              <div class="agent-info">
                <div class="agent-name">${escapeHtml(agent.name)}</div>
                <div class="agent-profession">${escapeHtml(getAgentProfession(agent))}</div>
              </div>
            </div>
            <div class="agent-status"><span class="status-dot"></span> Active</div>
            <div class="agent-prompts-count">${promptCount} prompt${promptCount !== 1 ? 's' : ''}</div>
          </div>`;
      }).join('');
    }

    let agentsData = [];

    function openAgent(id) {
      const agent = agentsData.find(a => a.id === id);
      if (!agent) return;

      const color = hashColor(agent.name);
      const initial = agent.name.charAt(0).toUpperCase();

      document.getElementById('modal-avatar').style.background = color;
      document.getElementById('modal-avatar').textContent = initial;
      document.getElementById('modal-title').textContent = agent.name;
      document.getElementById('modal-subtitle').textContent = getAgentProfession(agent);

      const body = document.getElementById('modal-body');
      const prompts = agent.prompts || {};
      const keys = Object.keys(prompts);

      if (keys.length === 0) {
        body.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No prompts configured for this agent.</p>';
      } else {
        body.innerHTML = keys.map(key => `
          <div class="prompt-section">
            <div class="prompt-label">${escapeHtml(key)}</div>
            <div class="prompt-content">${escapeHtml(prompts[key])}</div>
          </div>
        `).join('');
      }

      document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
    }

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-overlay').addEventListener('click', e => {
      if (e.target === document.getElementById('modal-overlay')) closeModal();
    });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    function escapeHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    // Fetch agents from API
    async function loadAgents() {
      try {
        const resp = await fetch('/api/agents');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        agentsData = await resp.json();
        renderAgents(agentsData);
      } catch (err) {
        console.error('Failed to load agents:', err);
        document.getElementById('agents-grid').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x26a0;&#xfe0f;</div>
            <p>Failed to load agents. Is the server running?</p>
          </div>`;
      }
    }

    // Check for custom logo
    (function() {
      const img = new Image();
      img.onload = function() {
        const el = document.getElementById('logo-icon');
        el.textContent = '';
        el.classList.add('has-logo');
        el.appendChild(img);
      };
      img.src = 'logo.png';
    })();

    // Load header title from settings
    (async function() {
      try {
        const resp = await fetch('/api/settings');
        if (resp.ok) {
          const data = await resp.json();
          if (data.header) {
            document.getElementById('header-title').textContent = data.header;
            document.title = data.header + ' — Agent Manager';
          }
        }
      } catch(e) {}
    })();

    // ── Integration SVG logos ──────────────────────
    const INTEGRATION_LOGOS = {
      slack: `<svg viewBox="0 0 128 128"><path d="M27.255 80.719c0 7.33-5.978 13.317-13.309 13.317C6.616 94.036.63 88.049.63 80.719s5.987-13.317 13.317-13.317h13.309zm6.709 0c0-7.33 5.987-13.317 13.317-13.317s13.317 5.986 13.317 13.317v33.335c0 7.33-5.986 13.317-13.317 13.317-7.33 0-13.317-5.987-13.317-13.317zm0 0" fill="#de1c59"/><path d="M47.281 27.255c-7.33 0-13.317-5.978-13.317-13.309C33.964 6.616 39.951.63 47.281.63s13.317 5.987 13.317 13.317v13.309zm0 6.709c7.33 0 13.317 5.987 13.317 13.317s-5.986 13.317-13.317 13.317H13.946C6.616 60.598.63 54.612.63 47.281c0-7.33 5.987-13.317 13.317-13.317zm0 0" fill="#35c5f0"/><path d="M100.745 47.281c0-7.33 5.978-13.317 13.309-13.317 7.33 0 13.317 5.987 13.317 13.317s-5.987 13.317-13.317 13.317h-13.309zm-6.709 0c0 7.33-5.987 13.317-13.317 13.317S67.402 54.612 67.402 47.281V13.946C67.402 6.616 73.388.63 80.719.63c7.33 0 13.317 5.987 13.317 13.317zm0 0" fill="#2eb67d"/><path d="M80.719 100.745c7.33 0 13.317 5.978 13.317 13.309 0 7.33-5.987 13.317-13.317 13.317s-13.317-5.987-13.317-13.317v-13.309zm0-6.709c-7.33 0-13.317-5.987-13.317-13.317s5.986-13.317 13.317-13.317h33.335c7.33 0 13.317 5.986 13.317 13.317 0 7.33-5.987 13.317-13.317 13.317zm0 0" fill="#ecb12f"/></svg>`,
      github: `<svg viewBox="0 0 128 128"><g fill="#e4e4e7"><path fill-rule="evenodd" clip-rule="evenodd" d="M64 5.103c-33.347 0-60.388 27.035-60.388 60.388 0 26.682 17.303 49.317 41.297 57.303 3.017.56 4.125-1.31 4.125-2.905 0-1.44-.056-6.197-.082-11.243-16.8 3.653-20.345-7.125-20.345-7.125-2.747-6.98-6.705-8.836-6.705-8.836-5.48-3.748.413-3.67.413-3.67 6.063.425 9.257 6.223 9.257 6.223 5.386 9.23 14.127 6.562 17.573 5.02.542-3.903 2.107-6.568 3.834-8.076-13.413-1.525-27.514-6.704-27.514-29.843 0-6.593 2.36-11.98 6.223-16.21-.628-1.52-2.695-7.662.584-15.98 0 0 5.07-1.623 16.61 6.19C53.7 35 58.867 34.327 64 34.304c5.13.023 10.3.694 15.127 2.033 11.526-7.813 16.59-6.19 16.59-6.19 3.287 8.317 1.22 14.46.593 15.98 3.872 4.23 6.215 9.617 6.215 16.21 0 23.194-14.127 28.3-27.574 29.796 2.167 1.874 4.097 5.55 4.097 11.183 0 8.08-.07 14.583-.07 16.572 0 1.607 1.088 3.49 4.148 2.897 23.98-7.994 41.263-30.622 41.263-57.294C124.388 32.14 97.35 5.104 64 5.104z"/><path d="M26.484 91.806c-.133.3-.605.39-1.035.185-.44-.196-.685-.605-.543-.906.13-.31.603-.395 1.04-.188.44.197.69.61.537.91zm2.446 2.729c-.287.267-.85.143-1.232-.28-.396-.42-.47-.983-.177-1.254.298-.266.844-.14 1.24.28.394.426.472.984.17 1.255zm2.382 3.477c-.37.258-.976.017-1.35-.52-.37-.538-.37-1.183.01-1.44.373-.258.97-.025 1.35.507.368.545.368 1.19-.01 1.452zm3.261 3.361c-.33.365-1.036.267-1.552-.23-.528-.487-.674-1.18-.343-1.544.336-.366 1.045-.264 1.564.23.527.486.686 1.18.33 1.544zm4.5 1.951c-.147.473-.825.688-1.51.486-.683-.207-1.13-.76-.99-1.238.14-.477.823-.7 1.512-.485.683.206 1.13.756.988 1.237zm4.943.361c.017.498-.563.91-1.28.92-.723.017-1.308-.387-1.315-.877 0-.503.568-.91 1.29-.924.717-.013 1.306.387 1.306.88zm4.598-.782c.086.485-.413.984-1.126 1.117-.7.13-1.35-.172-1.44-.653-.086-.498.422-.997 1.122-1.126.714-.123 1.354.17 1.444.663zm0 0"/></g></svg>`,
      jira: `<svg viewBox="0 0 128 128"><defs><linearGradient id="jira-a" x1="22.034" y1="9.773" x2="17.118" y2="14.842" gradientTransform="scale(4)" gradientUnits="userSpaceOnUse"><stop offset=".18" stop-color="#0052cc"/><stop offset="1" stop-color="#2684ff"/></linearGradient><linearGradient id="jira-b" x1="16.641" y1="15.63" x2="10.957" y2="21.09" gradientTransform="scale(4)" gradientUnits="userSpaceOnUse"><stop offset=".18" stop-color="#0052cc"/><stop offset="1" stop-color="#2684ff"/></linearGradient></defs><path d="M122.146 62.19L68.17 8.214 64 4.07 21.32 46.746 4.07 63.996l17.25 17.25L64 123.93l42.07-42.066.61-.61zm-58.15-16.31L80.62 62.5H46.56zm0 36.74L46.56 65.5h34.06z" fill="#2684ff"/><path d="M64 45.88C63.46 28.17 49.68 13.79 32.07 12.5L2.17 42.4l18.56 18.56z" fill="url(#jira-a)"/><path d="M81.1 62.5L64 79.62c.52 17.83 14.47 32.3 32.19 33.46l29.64-29.64-18.56-18.56z" fill="url(#jira-b)"/></svg>`,
      'azure-openai': `<svg viewBox="0 0 128 128"><path d="M64 8L8 36v56l56 28 56-28V36zm0 8.5L112 40v48L64 111.5 16 88V40z" fill="#0078d4"/><path d="M64 20L20 44v40l44 22 44-22V44zm0 7l36 18v32L64 95 28 77V45z" fill="#50e6ff"/><circle cx="64" cy="64" r="12" fill="#0078d4"/></svg>`,
    };

    const INTEGRATION_COLORS = {
      slack: '#4A154B',
      github: '#24292e',
      jira: '#0052CC',
      'azure-openai': '#0078d4',
    };

    let integrationsData = [];
    let expandedIntegration = null;

    function renderIntegrations(integrations) {
      const grid = document.getElementById('integrations-grid');
      const detailPanel = document.getElementById('integration-detail');
      if (integrations.length === 0) {
        grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;padding:30px;"><p>No integrations found.</p></div>`;
        detailPanel.innerHTML = '';
        return;
      }

      // Always render all cards as compact in the grid.
      grid.innerHTML = integrations.map(ig => {
        const logo = INTEGRATION_LOGOS[ig.id] || '';
        const statusClass = ig.configured ? 'connected' : 'disconnected';
        const statusLabel = ig.configured ? 'Connected' : 'Not configured';
        const statusDot = ig.configured ? '●' : '○';
        const selectedClass = expandedIntegration === ig.id ? ' expanded' : '';

        return `
          <div class="integration-card${selectedClass}" data-id="${ig.id}" onclick="toggleIntegration('${ig.id}')">
            <div class="integration-logo">${logo}</div>
            <div class="integration-name">${escapeHtml(ig.name)}</div>
            <span class="integration-status ${statusClass}">${statusDot} ${statusLabel}</span>
            ${ig.auth_mode ? `<div class="integration-auth-mode">${escapeHtml(ig.auth_mode)}</div>` : ''}
          </div>`;
      }).join('');

      // Render the detail panel below the grid for the selected integration.
      if (!expandedIntegration) {
        detailPanel.innerHTML = '';
        return;
      }
      const ig = integrations.find(i => i.id === expandedIntegration);
      if (!ig) { detailPanel.innerHTML = ''; return; }

      const logo = INTEGRATION_LOGOS[ig.id] || '';
      const statusClass = ig.configured ? 'connected' : 'disconnected';
      const statusLabel = ig.configured ? 'Connected' : 'Not configured';
      const statusDot = ig.configured ? '●' : '○';

      detailPanel.innerHTML = `
        <div class="integration-detail-panel">
          <div class="integration-detail-header">
            <div class="integration-logo">${logo}</div>
            <div>
              <div class="integration-name">${escapeHtml(ig.name)}</div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:4px;">
                <span class="integration-status ${statusClass}">${statusDot} ${statusLabel}</span>
                ${ig.auth_mode ? `<span class="integration-auth-mode">${escapeHtml(ig.auth_mode)}</span>` : ''}
              </div>
            </div>
            <button class="integration-detail-close" onclick="toggleIntegration('${ig.id}')" title="Close">&times;</button>
          </div>
          ${ig.active_model ? `<div class="integration-active-model"><span class="model-label">Active Model</span><span class="model-value">${escapeHtml(ig.active_model)}</span></div>` : ''}
          <table class="permissions-table">
            <thead>
              <tr>
                <th>Scope / Permission</th>
                <th>Description</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${ig.permissions.map(p => {
                let statusHtml;
                if (p.extra) {
                  statusHtml = '<span class="perm-status warning"><span class="perm-status-icon">⚠</span> Extra</span>';
                } else if (p.granted === true) {
                  statusHtml = '<span class="perm-status granted"><span class="perm-status-icon">✓</span> Granted</span>';
                } else if (p.granted === false) {
                  statusHtml = '<span class="perm-status denied"><span class="perm-status-icon">✗</span> Missing</span>';
                } else {
                  statusHtml = '<span class="perm-status unknown">—</span>';
                }
                const badgeClass = p.extra ? 'extra' : (p.required ? 'required' : 'optional');
                const badgeLabel = p.extra ? 'Extra' : (p.required ? 'Required' : 'Optional');
                return `
                <tr>
                  <td class="scope-name">${escapeHtml(p.scope)}</td>
                  <td class="scope-desc">${p.description ? escapeHtml(p.description) : '<span style="color:var(--text-muted);font-style:italic">Not used by arbetern</span>'}</td>
                  <td>${statusHtml}</td>
                  <td><span class="perm-badge ${badgeClass}">${badgeLabel}</span></td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;
    }

    function toggleIntegration(id) {
      expandedIntegration = expandedIntegration === id ? null : id;
      renderIntegrations(integrationsData);
    }

    async function loadIntegrations() {
      try {
        const resp = await fetch('/api/integrations');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        integrationsData = await resp.json();
        renderIntegrations(integrationsData);
      } catch (err) {
        console.error('Failed to load integrations:', err);
        document.getElementById('integrations-grid').innerHTML = `
          <div class="empty-state" style="grid-column:1/-1;padding:30px;">
            <p>Failed to load integrations.</p>
          </div>`;
      }
    }

    loadIntegrations();
    loadAgents();
  </script>
</body>
</html>
