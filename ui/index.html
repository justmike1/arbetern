<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <title>ovad — Agent Manager</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #000000;
      --surface: #0d0d0d;
      --card: #141414;
      --card-hover: #1a1a1a;
      --border: #1f1f1f;
      --border-accent: #2a2a2a;
      --text: #e4e4e7;
      --text-muted: #71717a;
      --accent: #6366f1;
      --accent-glow: rgba(99, 102, 241, 0.15);
      --green: #22c55e;
      --radius: 12px;
      --radius-lg: 16px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Header ─────────────────────────────────── */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 32px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #fff;
    }

    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 8px;
    }

    .logo-icon.has-logo {
      background: transparent;
    }

    .header-badge {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--card);
      padding: 4px 10px;
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    /* ── Main Grid ──────────────────────────────── */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
    }

    .agents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    /* ── Agent Card ─────────────────────────────── */
    .agent-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .agent-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--accent);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .agent-card:hover {
      background: var(--card-hover);
      border-color: var(--border-accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .agent-card:hover::before {
      opacity: 1;
    }

    .agent-card-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 14px;
    }

    .agent-avatar {
      width: 44px;
      height: 44px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    .agent-info { flex: 1; min-width: 0; }

    .agent-name {
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .agent-profession {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .agent-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--green);
      margin-top: 12px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      background: var(--green);
      border-radius: 50%;
    }

    .agent-prompts-count {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* ── Modal / Slide-over ─────────────────────── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: min(560px, 100vw);
      background: var(--surface);
      border-left: 1px solid var(--border);
      z-index: 201;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      flex-direction: column;
    }

    .modal-overlay.active .modal-panel {
      transform: translateX(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .modal-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-agent-avatar {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
    }

    .modal-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .modal-close {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.15s ease;
    }

    .modal-close:hover {
      color: var(--text);
      background: var(--card-hover);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .prompt-section {
      margin-bottom: 24px;
    }

    .prompt-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .prompt-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      font-size: 13px;
      line-height: 1.7;
      color: var(--text-muted);
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'SF Mono', 'Fira Code', monospace;
      user-select: text;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .readonly-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      background: var(--card);
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 20px;
    }

    .readonly-badge svg {
      width: 14px;
      height: 14px;
    }

    /* ── Empty State ────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state p {
      font-size: 14px;
      max-width: 320px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* ── Scrollbar ──────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* ── Responsive ─────────────────────────────── */
    @media (max-width: 640px) {
      header { padding: 16px; }
      main { padding: 20px 16px; }
      .agents-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">
      <div class="logo-icon" id="logo-icon">O</div>
      <span id="header-title">ovad</span>
    </div>
    <span class="header-badge" id="agent-count">0 agents</span>
  </header>

  <main>
    <div class="section-title">Agents</div>
    <div class="agents-grid" id="agents-grid">
      <div class="empty-state">
        <div class="empty-state-icon">&#x1f916;</div>
        <p>Loading agents...</p>
      </div>
    </div>
  </main>

  <!-- Slide-over panel -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-panel" id="modal-panel">
      <div class="modal-header">
        <div class="modal-header-left">
          <div class="modal-agent-avatar" id="modal-avatar"></div>
          <div>
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-subtitle" id="modal-subtitle"></div>
          </div>
        </div>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer">
        <div class="readonly-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          Read-only — prompts cannot be edited from the UI
        </div>
      </div>
    </div>
  </div>

  <script>
    const AGENT_COLORS = [
      '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e',
      '#f97316', '#eab308', '#22c55e', '#14b8a6',
      '#06b6d4', '#3b82f6',
    ];

    function hashColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      return AGENT_COLORS[Math.abs(hash) % AGENT_COLORS.length];
    }

    function getAgentProfession(agent) {
      // Try to extract profession from the general or security prompt's first meaningful line.
      const general = (agent.prompts || {}).general || '';
      const match = general.match(/You are (?:a |an )?([^.\n]+)/i);
      if (match) return match[1].trim();
      return agent.id;
    }

    function renderAgents(agents) {
      const grid = document.getElementById('agents-grid');
      const countBadge = document.getElementById('agent-count');
      countBadge.textContent = `${agents.length} agent${agents.length !== 1 ? 's' : ''}`;

      if (agents.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x1f916;</div>
            <p>No agents configured yet. Agents will appear here once created.</p>
          </div>`;
        return;
      }

      grid.innerHTML = agents.map(agent => {
        const color = hashColor(agent.name);
        const initial = agent.name.charAt(0).toUpperCase();
        const promptCount = Object.keys(agent.prompts || {}).length;
        return `
          <div class="agent-card" data-agent-id="${agent.id}" onclick="openAgent('${agent.id}')">
            <div class="agent-card-header">
              <div class="agent-avatar" style="background:${color}">${initial}</div>
              <div class="agent-info">
                <div class="agent-name">${escapeHtml(agent.name)}</div>
                <div class="agent-profession">${escapeHtml(getAgentProfession(agent))}</div>
              </div>
            </div>
            <div class="agent-status"><span class="status-dot"></span> Active</div>
            <div class="agent-prompts-count">${promptCount} prompt${promptCount !== 1 ? 's' : ''}</div>
          </div>`;
      }).join('');
    }

    let agentsData = [];

    function openAgent(id) {
      const agent = agentsData.find(a => a.id === id);
      if (!agent) return;

      const color = hashColor(agent.name);
      const initial = agent.name.charAt(0).toUpperCase();

      document.getElementById('modal-avatar').style.background = color;
      document.getElementById('modal-avatar').textContent = initial;
      document.getElementById('modal-title').textContent = agent.name;
      document.getElementById('modal-subtitle').textContent = getAgentProfession(agent);

      const body = document.getElementById('modal-body');
      const prompts = agent.prompts || {};
      const keys = Object.keys(prompts);

      if (keys.length === 0) {
        body.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No prompts configured for this agent.</p>';
      } else {
        body.innerHTML = keys.map(key => `
          <div class="prompt-section">
            <div class="prompt-label">${escapeHtml(key)}</div>
            <div class="prompt-content">${escapeHtml(prompts[key])}</div>
          </div>
        `).join('');
      }

      document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
    }

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-overlay').addEventListener('click', e => {
      if (e.target === document.getElementById('modal-overlay')) closeModal();
    });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    function escapeHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    // Fetch agents from API
    async function loadAgents() {
      try {
        const resp = await fetch('/api/agents');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        agentsData = await resp.json();
        renderAgents(agentsData);
      } catch (err) {
        console.error('Failed to load agents:', err);
        document.getElementById('agents-grid').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#x26a0;&#xfe0f;</div>
            <p>Failed to load agents. Is the server running?</p>
          </div>`;
      }
    }

    // Check for custom logo
    (function() {
      const img = new Image();
      img.onload = function() {
        const el = document.getElementById('logo-icon');
        el.textContent = '';
        el.classList.add('has-logo');
        el.appendChild(img);
      };
      img.src = 'logo.png';
    })();

    // Load header title from settings
    (async function() {
      try {
        const resp = await fetch('/api/settings');
        if (resp.ok) {
          const data = await resp.json();
          if (data.header) {
            document.getElementById('header-title').textContent = data.header;
            document.title = data.header + ' — Agent Manager';
          }
        }
      } catch(e) {}
    })();

    loadAgents();
  </script>
</body>
</html>
